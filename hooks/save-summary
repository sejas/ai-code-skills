#!/bin/bash
# Wrapper for save-summary.py - sets up venv if needed
# Runs in background so session exit isn't blocked

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
VENV_PYTHON="$VENV_DIR/bin/python"

# Read stdin before backgrounding (hooks pass JSON via stdin)
JSON_DATA=$(cat)

# Bootstrap venv if needed
if [[ ! -f "$VENV_PYTHON" ]]; then
    python3 -m venv "$VENV_DIR" 2>/dev/null
    "$VENV_DIR/bin/pip" install -q claude-agent-sdk 2>/dev/null
fi

if [[ -f "$VENV_PYTHON" ]]; then
    echo "$JSON_DATA" | nohup "$VENV_PYTHON" "$SCRIPT_DIR/save-summary.py" >/dev/null 2>&1 &
    echo "Session summary started in background"
else
    echo "Failed to set up Python environment"
    exit 1
fi
